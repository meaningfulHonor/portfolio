<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}" lang="ko-kr">
<head>
<meta charset="UTF-8">
<title>게시글 수정</title>

	<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>
  
<script>

// summmernote 삽입 이미지 파일 업로드 전송
function sendFile(file, el) {

  // FormData 객체 

  let formData = new FormData();
  formData.append('file', file);
  
  // jQuery AJAX
  $.ajax({
	  
    data: formData,
    type: "POST", // 업로드시 필수사항
    url: '/portfolio/notice/image',
    cache: false,
    contentType: false,
    enctype: 'multipart/form-data', // 업로드시 필수사항 
    processData: false,
    
    success: function(url) {
    	
    	console.log("이미지 URL : ", url);
    
    	$(el).summernote('editor.insertImage', url);
    	
     	// $('#imageNotice').append('<li><img src="'+url+'" width="480" height="auto"/></li>');
     	
    } //
    
  });
  
}

$(function() {
	
	// case-1
	// $('#noticeContent').summernote(
			
	// case-2
	$('#noticeContent').summernote(
			{
				placeholder : '글 내용을 작성하십시오',
				tabsize : 2,
				height : 300,
				theme: 'simplex',
				toolbar : [ [ 'style', [ 'style' ] ],
						[ 'font', [ 'bold', 'underline', 'clear' ] ],
						[ 'color', [ 'color' ] ],
						[ 'para', [ 'ul', 'ol', 'paragraph' ] ],
						[ 'table', [ 'table' ] ],
						[ 'insert', [ 'link', 'picture', 'video' ] ],
						[ 'view', [ 'fullscreen', 'codeview', 'help' ] ] ]
			
				
				,lang : 'ko-kr',
				
				// 참고) 전송 방법
				// 참고로, 컨텐츠 내의 삽입 이미지들을 아래와 같이 파일 업로드 처리를 하지 않으면,
				// base64 알고리즘으로 암호화된 데이터 스트림(data stream) 형태로 전송됩니다.
				callbacks : {
					
					// 참고) onImageUpload 이벤트(event)
					// : https://summernote.org/deep-dive/#onimageupload
					
					onImageUpload: function(files, editor, welEditable) {
						
						console.log("업로드할 이미지 파일들 : ", files.length);
						
		                for (var i = files.length - 1; i >= 0; i--) {
		              		sendFile(files[i], this);
		                } // for
		              
		            } // onImageUpload
					
				} //callbacks
			
			});
});

window.onload = function() {
	
	// 게시글 내용
	let noticeContent = document.getElementById("noticeContent");
	let noticeForm = document.getElementById("notice_update_frm");
	
	// summernote actual component : 썸머노트의 실제 글내용 컴포넌트
	// F12 → Elements 탭 메뉴 코너에서 확인할 수 있습니다.
	let summernoteActualContent = document.querySelector(".note-editable");
	
	// 폼점검
	noticeForm.onsubmit = () => {
		
		let content = summernoteActualContent.innerHTML;
				
		// 실제 전송용 필드에 입력
		noticeContent.value = content;
		
		content = content.replaceAll('<p><br></p>', '')
					     .replaceAll('&nbsp;', '')
					     .replaceAll('<p>', '')
					     .replaceAll('</p>', '')
					     .trim()
					     
		console.log("content : ", content.length); 
		
		if (content.length == 0) {
		
			alert("게시글 내용을 입력하십시오.");
			noticeContent.focus(); // 썸머노트의 실제 글내용 컴포넌트에 focus(입력 대기)
			
			return false; // 전송 취소
		}
		
		// 파일 업로드 사이즈 체크 : 10MB 보다 큰지 점검
		let noticeFile = document.getElementById("noticeFile");
		// 버그 패치 (빈 파일일 경우)
		let uploadFileSize = (noticeFile.value == "") ? 0 : noticeFile.files[0].size;
		
		const maxUploadFileSize = 10 * 1024 * 1024; // 10MB
		
		if (uploadFileSize > maxUploadFileSize) {
			
			alert("10 MB 보다 큰 파일은 올릴 수 없습니다.");
			noticeFile.value = ""; // 초기화
			noticeFile.focus(); // 재입력 대기
			return false;
		} //
		
		alert("글 수정 전송");
		
	} //
	
}
</script>

<link rel="stylesheet" th:href="@{/css/noticeReWrite.css}">

</head>
<body>

	<!-- layout -->
	<div layout:fragment="content" class="main_sect_pnl">

		<div class="content_sect_pnl">
		<!-- 
			session(기존 정보) : [[${session.noticeUpdateSess}]]
			<hr>
			[[${notice}]]
		 -->
			<form id="notice_update_frm" th:action="@{'/notice/updateProc.do'}"
				encType="multipart/form-data" method="post" th:object="${notice}">
				
				<!-- 기존 정보 전송용 히든 필드 -->
				<!-- <input type="hidden" id="noticeReRef" name="noticeReRef" th:value="${notice.noticeReRef}" />
				<input type="hidden" id="noticeReLev" name="noticeReLev" th:value="${notice.noticeReLev}" />
				<input type="hidden" id="noticeReRef" name="noticeReRef" th:value="${notice.noticeReRef}" />
				<input type="hidden" id="noticeReSeq" name="noticeReSeq" th:value="${notice.noticeReSeq}" /> -->
				<!--// 기존 정보 전송용 히든 필드 -->
				
				<h2 class="main_title">게시글 수정</h2>
				
				<div class="write_notice">
					<ul>
						<li>
							<span class="left_col">글 번호</span>
							<span class="right_col">
								<input type="text" class="form-control" id="noticeNum" name="noticeNum" 
								th:value="${notice.noticeNum}" th:field="*{noticeNum}" readonly />
							</span>
						</li>
						<li>
							<span class="left_col">작 성 자</span>
							<span class="right_col">
								<input type="text" class="form-control" id="noticeWriter"
									name="noticeWriter" th:value="${notice.noticeWriter}" th:field="*{noticeWriter}" readonly />
							</span>
						</li>
					<li>
						<span class="left_col">패쓰워드</span>
						<span class="right_col">
							<input type="text" class="form-control" id="noticePass"
								name="noticePass" required 
								pattern="(?=.*[a-zA-Z])((?=.*\d)(?=.*\W)).{8,20}"
								title="최소 1개의 숫자 혹은 특수 문자를 포함하여 8~20자 사이로 패쓰워드를 입력하십시오" 
								th:field="*{noticePass}" />
						</span>
					</li>
					<li class="upper-side">
						<span class="left_col">제  목</span>
						<span class="right_col">
							<input type="text" class="form-control" id="noticeSubject"
							name="noticeSubject" required title="글제목을 입력하십시오" th:value="${notice.noticeSubject}" 
							th:field="*{noticeSubject}"/>
						</span>
					</li>
				</ul>
			
				<div class="content_area">	
					<textarea class="form-control" id="noticeContent"
							name="noticeContent" th:field="*{noticeContent}" required>[[${notice.noticeContent}]]</textarea>
				</div>
				
				<ul>
					<li class="lower-side">
						<span class="left_col">첨부파일</span>
						<span class="right_col">
							<span th:if="${#strings.isEmpty(notice.noticeFile)}">첨부 파일 없음</span>
							
							<a th:href="@{'/notice/download/'+${notice.noticeOriginalFile}+'/'+${notice.noticeFile}}" 
							   th:if="${!#strings.isEmpty(notice.noticeOriginalFile)}" 
							   th:utext="${notice.noticeOriginalFile}"></a><br>
							    
							<input class="form-control mt-3 mb-2" type="file" id="noticeFile" name="noticeFile" th:field="*{noticeFile}">
						</span>
					</li>
					<li class="lower-side">
						<span class="left_col">등록일</span>
						<span class="right_col" th:utext="${#dates.format(notice.noticeDate, 'yyyy-MM-dd HH:mm:ss')}"></span>
					</li>
				</ul>
			</div>
				

				<div class="write_btn_pnl">
					<button type="submit" class="btn btn-primary">수정 완료</button>
					&nbsp;
					<button type="reset" class="btn btn-primary">취소</button>
				</div>

			</form>

		</div>
		<!--// content -->

	</div>
	<!--// layout -->

</body>
</html>


<!-- 				<h2 class="d-flex justify-content-center">게시글 수정</h2>

				<table class="table mx-auto mt-4" style="width: 800px;">
				
					<tr>
						<th scope="col" class="col-2">게시글 번호</th>
						<td>
							<input type="text" class="form-control" id="noticeNum" name="noticeNum" 
								th:value="${notice.noticeNum}" th:field="*{noticeNum}" readonly />
						</td>
					</tr>

					<tr>
						<th scope="col">작성자</th>
						<td><input type="text" class="form-control" id="noticeWriter"
							name="noticeWriter" th:value="${notice.noticeWriter}" th:field="*{noticeWriter}" readonly /></td>
					</tr>

					<tr>
						<th scope="col">패쓰워드</th>
						<td><input type="text" class="form-control" id="noticePass"
							name="noticePass" required 
							pattern="(?=.*[a-zA-Z])((?=.*\d)(?=.*\W)).{8,20}" title="최소 1개의 숫자 혹은 특수 문자를 포함하여 8~20자 사이로 패쓰워드를 입력하십시오" 
							th:field="*{noticePass}" /></td>
					</tr>

					<tr>
						<th scope="col">제목</th>
						<td><input type="text" class="form-control" id="noticeSubject"
							name="noticeSubject" required title="글제목을 입력하십시오" th:value="${notice.noticeSubject}" 
							th:field="*{noticeSubject}"/></td>
					</tr>

					<tr>
						<th scope="col">내용</th>
						<td>							
							case-1
							<textarea class="form-control" id="noticeContent"
								name="noticeContent" th:field="*{noticeContent}" required>[[${notice.noticeContent}]]</textarea>
							 
							case-2
							<div id="noticeContentDiv"></div>
							<input type="hidden" id="noticeContent" name="noticeContent" />
						</td>
					</tr>

					<tr>
						<th scope="col">첨부파일</th>
						<td>
							<span th:if="${#strings.isEmpty(notice.noticeFile)}">첨부 파일 없음</span>
							
							<a th:href="@{'/notice/download/'+${notice.noticeOriginalFile}+'/'+${notice.noticeFile}}" 
							   th:if="${!#strings.isEmpty(notice.noticeOriginalFile)}" 
							   th:utext="${notice.noticeOriginalFile}"></a><br>
							    
							<input class="form-control mt-3 mb-2" type="file" id="noticeFile" name="noticeFile" th:field="*{noticeFile}">
						</td>
					</tr>
					
					<tr>
						<th scope="col">등록일</th>
						<td th:utext="${#dates.format(notice.noticeDate, 'yyyy-MM-dd HH:mm:ss')}"></td>
					</tr>

				</table> -->